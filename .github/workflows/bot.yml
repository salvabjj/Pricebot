name: PriceBot_Run

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

jobs:
  rodar_bot:
    runs-on: ubuntu-latest
    permissions:
      contents: write # NecessÃ¡rio para o git push funcionar
    steps:
      - name: Copiar arquivos
        uses: actions/checkout@v4

      - name: Instalar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Instalar Bibliotecas
        run: |
          pip install requests beautifulsoup4 python-telegram-bot==13.15

      - name: Executar script
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: python Bot.py

      - name: ðŸ’¾ Salvar HistÃ³rico
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "action@github.com"
          git add History.json || true
          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ“Š HistÃ³rico atualizado [skip ci]" && git push)          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ“Š HistÃ³rico atualizado [skip ci]" && git push)    except Exception as e:
        print(f"Erro no scraping: {e}")
    return None

def main():
    bot = Bot(token=TOKEN)
    print("ðŸ¤– Iniciando monitoramento...")
    
    oferta = buscar_oferta()
    
    if oferta:
        msg = (
            f"ðŸ”¥ *OFERTA ENCONTRADA*\n\n"
            f"ðŸ“¦ {oferta['titulo']}\n"
            f"ðŸ’° *R$ {oferta['valor']}*\n\n"
            f"ðŸ›’ [VER NO SITE]({oferta['url']})"
        )
        # Na v13.15, o envio Ã© sÃ­ncrono (sem await)
        bot.send_message(chat_id=CHAT_ID, text=msg, parse_mode=ParseMode.MARKDOWN)
        print("âœ… Mensagem enviada!")
    else:
        print("0 ofertas capturadas nesta rodada.")

if __name__ == "__main__":
    main()
