name: Pricebot Pro - Captura Visual

on:
  schedule:
    # Roda a cada 2 horas para evitar bloqueio excessivo de IP
    - cron: '0 */2 * * *'
  workflow_dispatch: # Permite rodar manualmente pelo botÃ£o no GitHub

jobs:
  build:
    runs-on: ubuntu-latest

    # PermissÃµes necessÃ¡rias para salvar o histÃ³rico (History.json) de volta no repositÃ³rio
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout do RepositÃ³rio
        uses: actions/checkout@v4

      - name: ğŸ Configurar Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Instalar DependÃªncias e Navegador
        run: |
          python -m pip install --upgrade pip
          pip install playwright python-telegram-bot requests beautifulsoup4
          # Instala o motor do Chrome e as bibliotecas de sistema necessÃ¡rias
          playwright install chromium
          playwright install-deps chromium

      - name: ğŸ¤– Executar Bot de Captura (Prynt Sceen)
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: python Bot.py

      - name: ğŸ’¾ Salvar HistÃ³rico de Ofertas
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "action@github.com"
          git add History.json
          # SÃ³ faz o commit se houver mudanÃ§as para nÃ£o dar erro
          git diff --quiet && git diff --staged --quiet || (git commit -m "ğŸ“Š HistÃ³rico atualizado [skip ci]" && git push)    except Exception as e:
        print(f"Erro no scraping: {e}")
    return None

def main():
    bot = Bot(token=TOKEN)
    print("ğŸ¤– Iniciando monitoramento...")
    
    oferta = buscar_oferta()
    
    if oferta:
        msg = (
            f"ğŸ”¥ *OFERTA ENCONTRADA*\n\n"
            f"ğŸ“¦ {oferta['titulo']}\n"
            f"ğŸ’° *R$ {oferta['valor']}*\n\n"
            f"ğŸ›’ [VER NO SITE]({oferta['url']})"
        )
        # Na v13.15, o envio Ã© sÃ­ncrono (sem await)
        bot.send_message(chat_id=CHAT_ID, text=msg, parse_mode=ParseMode.MARKDOWN)
        print("âœ… Mensagem enviada!")
    else:
        print("0 ofertas capturadas nesta rodada.")

if __name__ == "__main__":
    main()
